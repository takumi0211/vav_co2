# Simulator Humid

High-resolution simulation and control sandbox for a humid-climate variable-air-volume (VAV) HVAC plant. The repo embeds the [phyvac](phyvac/README.md) physics engine, curates weather/occupancy datasets, and hosts multiple controllers (baseline PID, reinforcement learning, OpenAI/Ollama LLM supervisors) so future agents can compare policies on a consistent 4-zone scenario.

## Highlights
- 4-zone air and hydronic loop solved at 60 s timesteps with chilled-water pump/valve dynamics, fan affinity laws, CO₂, and humidity tracking.
- Self-contained `phyvac/` clone plus helper scripts for weather scraping, occupancy synthesis, PID tuning, reward inspection, and plotting.
- Baseline regressions (`simulator_humid.controllers.*`), RL trainers (`agents/rl` with SAC + TD3), and LLM supervisors share the same reward definition for apples-to-apples benchmarking.
- Deterministic output folders (`outputs/**/*`) and central path helpers (`simulator_humid.utils.paths`) keep artefacts predictable for automation.
- July 2025 JMA weather CSVs and ∼20 occupancy patterns per zone are already included so simulations can run fully offline.

## Repository Map (as of 2025-11-09)
```
.
├── simulator_humid/
│   ├── simulation.py          # Core VAV simulator
│   ├── controllers/           # Baseline PID + variants
│   ├── agents/
│   │   ├── rl/                # SAC & TD3 trainers/evaluators
│   │   ├── llm_agent.py       # OpenAI-based supervisor
│   │   └── ollama_agent.py    # Ollama-based supervisor
│   ├── data_tools/            # Weather + occupancy utilities
│   ├── optimization/          # PID grid search utilities
│   ├── plots/                 # Curve/summary plot scripts
│   └── utils/paths.py         # Centralised filesystem constants
├── phyvac/                    # Bundled upstream HVAC solver + docs
├── data/
│   ├── occupancy_scenarios/   # RL-ready JSON/CSV summaries
│   └── archive/               # Snapshots of canonical raw files
├── weather_data/              # 2025-07 JMA CSVs (10 min resolution)
├── people_data/               # zone*/zone*_pattern_XXX.csv libraries
├── outputs/
│   ├── baseline/              # Regression runs (PID, etc.)
│   ├── rl/                    # RL checkpoints, logs, plots
│   ├── llm/                   # OpenAI LLM artefacts
│   ├── ollama/                # Ollama LLM artefacts
│   ├── reference/             # PID optimisation benchmarks
│   ├── figures/               # Shared figures/pump & fan curves
│   └── simulations/           # Ad-hoc batch exports
├── requirements.txt
├── github-memo.md             # Handy git reset/push snippet
└── README.md (this document)
```
`.env` (ignored) stores API keys; `.DS_Store` files can be ignored.

## Environment Setup
1. Install Python 3.11+ (3.11 is what current `.pyc` files were built against).
2. Create and activate a virtual environment, then install dependencies:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
3. Populate `.env` (never commit real keys):
   ```
   OPENAI_API_KEY=sk-...
   OLLAMA_HOST=http://localhost:11434   # optional, defaults to local Ollama
   ```
4. GPU optional: PyTorch installs CPU wheels by default; install CUDA wheels manually if running RL on a GPU host.
5. `phyvac/` is imported via `simulator_humid/__init__.py`, so no extra install is required. Keep the folder in sync if upstream changes are pulled.

## Data Assets & Regeneration
- **`weather_data/`** – 32 CSVs (`outdoor_temp_20250628.csv` plus `outdoor_temp_202507XX.csv`) fetched from the JMA 10-min archive. Regenerate with `python -m simulator_humid.data_tools.scrape_weather`. `simulator_humid.simulation.OUTDOOR_DATA_PATH` defaults to `weather_data/outdoor_temp_20250628.csv`; update the constant or override upstream before running alternative weather.
- **`people_data/zone*`** – 20 occupancy patterns per zone (CSV with 24 hourly entries). Generated by `simulator_humid.data_tools.occupancy` (see module docstring) and used by RL when `randomize_occupancy=True`.
- **`data/occupancy_scenarios/*`** – Aggregated JSON/CSV describing each synthetic scenario; RL scripts sample from here.
- **`data/archive/`** – Canonical files you should not overwrite casually (currently keeps a copy of the July 29 weather CSV).
- **`outputs/`** – Structured artefacts for every experiment (baseline, RL, LLM, reference). Each script writes into a dedicated folder controlled via `simulator_humid.utils.paths`.
- **`phyvac/`** – Vendor solver clone with PDFs/tutorials inside `phyvac/Documents`. Consult these when extending hydronic/airflow components.
- **`github-memo.md`** – Quick git command reminder, especially handy when resetting the working tree before a new automation session.

## Core Workflows & Entry Points
### Baseline PID regression
Deterministic sanity check with four VAV zones.
```bash
python -m simulator_humid.controllers.baseline_pid
```
Outputs land in `outputs/baseline/baseline_pid/` (CSV, TXT metrics, comfort summary plots). Tune `selected_kp` / `selected_ti` or `_build_zones()` directly for new scenarios. `controllers/baseline_50.py` holds a simplified “50% damper” reference.

### PID gain search + reference run
Use `python -m simulator_humid.optimization.optimize_pid_and_run` to grid-search PID gains, evaluate `zone_pid_cost`, and dump results under `outputs/reference/`. Adjust the `kp_values` / `ti_values` sequences (near the bottom of the file) for finer sweeps.

### RL training (SAC / TD3)
- **SAC:** edit `simulator_humid.agents.rl.training_sac.TrainingConfig` (episodes, randomization flags, logging cadence) and run:
  ```bash
  python -m simulator_humid.agents.rl.training_sac
  ```
  This writes checkpoints (`sac_policy_final.pt`), replay statistics, plots, and optional teacher datasets under `outputs/rl/`.
- **TD3:** mirror the same process with `python -m simulator_humid.agents.rl.training_td3`. The folder already contains `training_log_td3.csv`, `td3_policy_final.pt`, and `plots_td3/` as references.

### RL policy evaluation
`simulator_humid.agents.rl.run_sac` and `run_td3` load trained checkpoints, enforce the same weather/occupancy settings as the LLM runs, execute one simulation, and drop CSV + plot artefacts under timestamped subfolders (defaults to `outputs/rl/sac_eval/*`). Configure the constants at the top of each script (checkpoint path, weather file, verbosity) before running `python -m simulator_humid.agents.rl.run_sac`.

### LLM supervisor (OpenAI)
Requires `OPENAI_API_KEY` (Responses API recommended). Run:
```bash
python -m simulator_humid.agents.llm_agent --llm-model gpt-4.1
```
The script builds the default 4-zone config, bounds actions via `ActionScaler`, pushes structured prompts to the model, and records everything in `outputs/llm/` (CSV logs, JSON summary, plots, `best_results.txt`). Override `--output-dir` to keep multiple experiment branches isolated. Model reasoning and applied actions are appended to `llm_actions_log.csv` for offline analysis.

### LLM supervisor (Ollama / local models)
Ensure the requested model is pulled (`ollama pull gemma3:4b` etc.) and, if needed, set `OLLAMA_HOST`. Run `python -m simulator_humid.agents.ollama_agent`. Artefacts mirror the OpenAI run but live under `outputs/ollama/`.

### Plotting & analysis helpers
- `python -m simulator_humid.plots.compare_results` compares CSVs stored under `outputs/*`.
- `python -m simulator_humid.plots.pump_hq_curve` and `python -m simulator_humid.plots.supply_fan_pq_curve` regenerate reference curves in `outputs/figures/`.

### Data refresh utilities
- Rebuild weather CSVs: `python -m simulator_humid.data_tools.scrape_weather` (downloads all days for July 2025; adjust URL params for other months).
- Generate occupancy libraries: see `simulator_humid.data_tools.occupancy` docstring (invocation pattern is documented at the top of the module).

## Key Modules & Extension Points
- `simulator_humid/simulation.py` – Houses dataclasses (`ZoneConfig`, `HVACActions`), occupancy helpers, weather ingestion, hydronic/air network solvers, and `run_simulation`. All controllers ultimately call this entry point.
- `simulator_humid/controllers/` – Baseline PID logic plus any deterministic benchmarks. Use these as regression targets before merging RL/LLM changes.
- `simulator_humid/agents/rl/` – SAC/TD3 implementations, observation normalisers, replay buffers, and policy wrappers. Reward shaping lives here; keep LLM/RL reward definitions in sync.
- `simulator_humid/agents/llm_agent.py` & `ollama_agent.py` – Prompt templates, action scaling/bounding, logging, and OpenAI/Ollama client handling. Update both when changing reward descriptions or actuator limits.
- `simulator_humid/data_tools/` – Weather scraping, occupancy synthesis, humidity calculators. Preferred place for one-off preprocessing scripts.
- `simulator_humid/optimization/` – PID gain sweeps and evaluation helpers (`compute_zone_pid_metrics`, `zone_pid_cost`).
- `simulator_humid/plots/` – Centralised figure scripts for fan/pump curves and scenario comparisons.
- `simulator_humid/utils/paths.py` – Source of truth for directories; import these constants instead of hard-coding file paths.

## Outputs & Logging
- `outputs/baseline/*` – CSV/PNG/TXT artefacts from deterministic controllers.
- `outputs/rl/*` – `training_log_*.csv`, `*_policy_final.pt`, `best_results_*.txt`, `plots_*`, and evaluation folders (`sac_eval`, `td3_eval`).
- `outputs/llm` & `outputs/ollama` – `llm_actions_log.csv`, `llm_simulation_results.csv`, `llm_summary.json`, `best_results.txt`, and per-run plots.
- `outputs/reference` – Golden benchmarks produced by the PID optimiser.
- `outputs/figures` – Pump/fan curves and other shareable figures.
- `outputs/simulations` – Free-form exports when scripts (or Jupyter) specify `SIMULATION_OUTPUT_DIR`.
All loggers rely on `Path.mkdir(..., exist_ok=True)` so folders are created automatically.

## Operational Checklist / Tips for the Next Agent
- Keep `OUTDOOR_DATA_PATH` aligned with the weather CSV you are analysing; every controller/RL script imports the constant from `simulator_humid.simulation` on module load.
- When changing actuator bounds or reward coefficients, update them in **all** entry points (simulation defaults, RL config, OpenAI/Ollama configs) to avoid silent divergences.
- Prefer `simulator_humid.utils.paths` over ad-hoc `Path("outputs/...")` literals when writing new scripts.
- If you add new dependencies, update `requirements.txt` and mention them here so automation agents know why installs might fail.
- Consider promoting the current defaults (OpenAI key, weather filename, occupancy paths) into CLI arguments/config files so future automation can run experiments without editing source.

Document changes here whenever modules move or new workflows appear—this README is the onboarding map for the next agent.
